import{O as x,P as H,t as S,R as V,U as g,V as $,w as q,M as z,p as K}from"./index-C9-8mdZk.js";function Q(e){let s=0;for(const a of e)a.stackId!==void 0&&s++;return s}const v=new Map;let m=!1;function W(){m=performance.now()}function X(){m=!1,v.clear()}function Y(e,s){v.set(s,e)}function P(e){if(!(m===!1||e.startTime<m))return v.get(e.startTime)}function Z(e){if(!(m===!1||e<m))for(const s of v.keys())s<e&&v.delete(s)}function ee({rawRumEvent:e,startTime:s}){if(e.type!=="long_task")return;const a=e.long_task.id;Y(a,s)}const te=(e,s,a,n)=>{const f=ne(e,s,a,n),l=se(e,f),o=s.build("fetch",l);return K("Sending profile to public profiling intake",{profilingIntakeURL:o,applicationId:a,sessionId:n}),fetch(o,{body:l.data,method:"POST"})};function ne(e,s,a,n){const f=s.tags,l=re(e,a,n),o=ie(f),r=new Date(e.timeOrigin+e.startTime),w=new Date(e.timeOrigin+e.endTime);return{...l,attachments:["wall-time.json"],start:r.toISOString(),end:w.toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:o.join(",")}}function ie(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}function se(e,s){const a=new Blob([JSON.stringify(e)],{type:"application/json"}),n=new FormData;return n.append("event",new Blob([JSON.stringify(s)],{type:"application/json"}),"event.json"),n.append("wall-time.json",a,"wall-time.json"),{data:n,bytesCount:0}}function re(e,s,a){const n={application:{id:s}};a&&(n.session={id:a});const f=Array.from(new Set(e.views.map(o=>o.viewId)));f.length&&(n.view={id:f});const l=e.longTasks.map(o=>P(o)).filter(o=>o!==void 0);return l.length&&(n.long_task={id:l}),n}const ae={sendProfile:te},oe={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function le(e,s,a,n=oe){const f=x(H.LONG_ANIMATION_FRAME);let l;const o=[];let r={state:"stopped"};function w(t){r.state!=="running"&&(l=t?{startTime:t.startClocks.relative,viewId:t.id,viewName:t.name}:void 0,o.push(S(e,window,"visibilitychange",_).stop,S(e,window,"beforeunload",D).stop),d())}async function R(){await T("stopped"),X(),o.forEach(t=>t())}function j(t){if(t.state==="running")return{cleanupTasks:t.cleanupTasks,observer:t.observer};const i=[];let c;if(e.trackLongTasks){c=new PerformanceObserver(E),c.observe({entryTypes:[L()]});const u=s.subscribe(12,b=>{ee(b)});W(),i.push(()=>c==null?void 0:c.disconnect()),i.push(u.unsubscribe)}const p=s.subscribe(2,u=>{I({viewId:u.id,viewName:u.name,startTime:u.startClocks.relative})});return i.push(p.unsubscribe),{cleanupTasks:i,observer:c}}function d(){const t=V().Profiler;if(!t)throw new Error("RUM Profiler is not supported in this browser.");h(r).catch(g);const{cleanupTasks:i,observer:c}=j(r);let p;try{p=new t({sampleInterval:n.sampleIntervalMs,maxBufferSize:Math.round(n.collectIntervalMs*1.5/n.sampleIntervalMs)})}catch(u){$.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",u);return}r={state:"running",startTime:performance.now(),profiler:p,timeoutId:q(d,n.collectIntervalMs),longTasks:[],views:[],cleanupTasks:i,observer:c},I(l),p.addEventListener("samplebufferfull",y)}async function h(t){var i,c;if(t.state!=="running")return;k((c=(i=t.observer)===null||i===void 0?void 0:i.takeRecords())!==null&&c!==void 0?c:[]),z(t.timeoutId),t.profiler.removeEventListener("samplebufferfull",y);const{startTime:p,longTasks:u,views:b}=t,F=performance.now();await t.profiler.stop().then(M=>{const O=performance.now(),C=u.length>0,G=O-p<n.minProfileDurationMs,J=Q(M.samples)<n.minNumberOfSamples;!C&&(G||J)||(N(Object.assign(M,{startTime:p,endTime:O,timeOrigin:performance.timeOrigin,longTasks:u,views:b,sampleInterval:n.sampleIntervalMs})),Z(F))}).catch(g)}async function T(t){r.state==="running"&&(r.cleanupTasks.forEach(i=>i()),await h(r),r={state:t})}function I(t){r.state!=="running"||!t||r.views.push(t)}function N(t){var i;const c=(i=a.findTrackedSession())===null||i===void 0?void 0:i.id;ae.sendProfile(t,e.profilingEndpointBuilder,e.applicationId,c).catch(g)}function y(){d()}function E(t){k(t.getEntries())}function k(t){if(r.state==="running")for(const i of t)i.duration<n.sampleIntervalMs||r.longTasks.push({id:P(i),duration:i.duration,entryType:i.entryType,startTime:i.startTime})}function _(){document.visibilityState==="hidden"&&r.state==="running"?T("paused").catch(g):document.visibilityState==="visible"&&r.state==="paused"&&d()}function D(){d()}function L(){return f?"long-animation-frame":"longtask"}function U(){return r.state==="stopped"}function A(){return r.state==="running"}function B(){return r.state==="paused"}return{start:w,stop:R,isStopped:U,isRunning:A,isPaused:B}}export{oe as DEFAULT_RUM_PROFILER_CONFIGURATION,le as createRumProfiler};
